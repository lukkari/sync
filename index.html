<!DOCTYPE html>
<html>
  <head>
    <title>Folder selection</title>
    <link href='./libs/template.css' media='all' rel='stylesheet' type='text/css' />
  </head>
  <body>
    <div class='app'>

      <h1>Settings</h1>

      <div class='settings'>

        <h2>Schedule contains</h2>
        <section>
          <div>
            <input type='radio' name='contains' id='radioCodeName' />
            <label for='radioCodeName'>Code:Name</label>
          </div>
          <div>
            <input type='radio' name='contains' id='radioCode' />
            <label for='radioCode'>Code</label>
          </div>
        </section>

        <h2>Folder to sync</h2>
        <section>
          <div>
            Selected folder: <code id='selected'></code>
          </div>
          <div>
            <input type='file' id='dir' webkitdirectory directory multiple />
          </div>
        </section>

        <h2>Select Mimosa text file</h2>
        <section id='mimosaCont'>
          <div>
            <input type='file' class='mimosaFile' />
            <select class='filterSelect'></select>
          </div>
          <div>
            <input type='file' class='mimosaFile' />
            <select class='filterSelect'></select>
          </div>
          <div>
            <input type='file' class='mimosaFile' />
            <select class='filterSelect'></select>
          </div>
        </section>

      </div>

    </div>


    <script>
    window.onload = function () {
      var ipc = require('ipc');

      var dir = document.querySelector('#dir');
      var selected = document.querySelector('#selected');
      //var mimosaFile = document.querySelector('#mimosaFile');
      var mimosaFiles = document.querySelectorAll('#mimosaCont input');
      var filterSelects = document.querySelectorAll('#mimosaCont select');

      dir.addEventListener('change', function (e) {
        if(!e.target.files.length) return;

        selected.innerText = e.target.files[0].path;
        // Update watchdir config
        ipc.send('watchdir', e.target.files[0].path);
      }, false);

      var mimosaFileHandler = function (e) {
        if(!e.target.files.length) return;

        // TODO: Get data in a better way
        var filter = e.target.nextSibling.nextSibling.value;
        ipc.send('mimosafile', {
          filter : filter,
          file : e.target.files[0].path
        });
      };

      for(var i = 0; i < mimosaFiles.length; i += 1) {
        mimosaFiles[i].addEventListener('change', mimosaFileHandler, false);
      }

      ipc.on('state', function (state) {
        selected.innerText = state.watchDir;
      });

      ipc.on('update_filters', function (filters) {
        console.log(filters);
        updateFilters(filters);
      });

      function updateFilters(filters) {
        var filterNode;
        if(!filters) return;

        for(var i = 0; i < filterSelects.length; i += 1) {
          filterNode = filterSelects[i];
          filterNode.innerHTML = '';
          filters.forEach(function (filter) {
            filterNode.innerHTML += '<option val="' + filter._id + '">' + filter.name + '</option>';
          });
        }
      }
    };
    </script>
  </body>
</html>
